<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tienda Online - E-commerce</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <header>
    <div class="header-container">
      <h1><a href="/products">🛍️ Tienda Online</a></h1>
      <nav>
        <a href="/products">📦 Productos</a>
        <a href="/realtimeproducts">⚡ Gestión</a>
        <a href="/cart/new" id="cart-link">🛒 Carrito</a>
        
        <!-- Enlaces de autenticación -->
        <div class="auth-nav" id="auth-nav">
          <!-- Se llenará dinámicamente con JavaScript -->
        </div>
      </nav>
    </div>
  </header>
  
  <main>
    {{{body}}}
  </main>
  
  <footer>
    <div class="footer-container">
      <p>&copy; 2025 Tienda Online. created by Francisco Pourpour Proyecto Backend - MongoDB + Express + Socket.IO</p>
    </div>
  </footer>
  
  <!-- Cargar Socket.IO primero -->
  <script src="/socket.io/socket.io.js"></script>
  
  <!-- Cargar script principal -->
  <script src="/js/script.js"></script>
  
  <!-- Helper para comparaciones en Handlebars -->
  <script>
    // Función global para actualizar enlaces del carrito
    function updateGlobalCartLink(cartId) {
      const cartLink = document.getElementById('cart-link');
      if (cartLink && cartId) {
        cartLink.href = `/cart/${cartId}`;
      }
    }
    
    // Actualizar navegación según estado de autenticación
    function updateAuthNavigation() {
      const authNav = document.getElementById('auth-nav');
      const userData = JSON.parse(localStorage.getItem('userData') || '{}');
      const authToken = localStorage.getItem('authToken');
      
      if (authToken && userData.id) {
        // Usuario autenticado
        authNav.innerHTML = `
          <a href="/profile">👤 ${userData.first_name || 'Perfil'}</a>
          ${userData.role === 'admin' ? '<a href="/admin/dashboard">⚙️ Admin</a>' : ''}
          <a href="#" onclick="logout()" style="color: #dc3545;">🚪 Salir</a>
        `;
      } else {
        // Usuario no autenticado
        authNav.innerHTML = `
          <a href="/login">🔐 Iniciar Sesión</a>
          <a href="/register">📝 Registrarse</a>
        `;
      }
    }

    function logout() {
      if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userData');
        window.location.href = '/login';
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateAuthNavigation();
      
      const cartId = localStorage.getItem('cartId');
      if (cartId) {
        updateGlobalCartLink(cartId);
      }
    });
  </script>
</body>
</html>
