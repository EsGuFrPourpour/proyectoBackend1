<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tienda Online - E-commerce</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <header>
    <div class="header-container">
      <h1><a href="/products">ğŸ›ï¸ Tienda Online</a></h1>
      <nav>
        <a href="/products">ğŸ“¦ Productos</a>
        <!-- Solo mostrar GestiÃ³n a administradores -->
        <div id="admin-nav" style="display: none;">
          <a href="/realtimeproducts">âš¡ GestiÃ³n</a>
        </div>
        <a href="/cart/my-cart" id="cart-link">
          ğŸ›’ Carrito
          <span id="cart-counter" class="cart-counter" style="display: none;">0</span>
        </a>
        
        <!-- Enlaces de autenticaciÃ³n -->
        <div class="auth-nav" id="auth-nav">
          <!-- Se llenarÃ¡ dinÃ¡micamente con JavaScript -->
        </div>
      </nav>
    </div>
  </header>
  
  <main>
    {{{body}}}
  </main>
  
  <footer>
    <div class="footer-container">
      <p>&copy; 2025 Tienda Online. created by Francisco Pourpour Proyecto Backend - MongoDB + Express + Socket.IO</p>
    </div>
  </footer>
  
  <!-- Cargar Socket.IO primero -->
  <script src="/socket.io/socket.io.js"></script>
  
  <!-- Cargar script principal -->
  <script src="/js/script.js"></script>
  
  <!-- Helper para comparaciones en Handlebars -->
  <script>
    // FunciÃ³n global para actualizar enlaces del carrito
    function updateGlobalCartLink(cartId) {
      const cartLink = document.getElementById('cart-link');
      const cartCounter = document.getElementById('cart-counter');
      if (cartLink && cartId && cartId !== 'undefined' && cartId !== 'null' && cartId !== '[object Object]') {
        const cartIdString = typeof cartId === 'object' ? (cartId._id || cartId.id || '') : String(cartId);
        if (cartIdString && cartIdString.length >= 24) {
          cartLink.href = `/cart/${cartIdString}`;
          cartLink.removeAttribute('data-action');
          
          // Actualizar contador de productos
          const itemCount = cartId.items ? cartId.items.length : 0;
          cartCounter.textContent = itemCount;
          cartCounter.style.display = itemCount > 0 ? 'inline' : 'none';
        }
      }
    }
    
    function goToCart() {
      const authToken = localStorage.getItem('authToken');
      if (!authToken) {
        alert('Debes iniciar sesiÃ³n para acceder al carrito');
        window.location.href = '/login';
        return;
      }
      window.location.href = '/cart/my-cart';
    }
    
    function logout() {
      if (confirm('Â¿EstÃ¡s seguro de que quieres cerrar sesiÃ³n?')) {
        localStorage.removeItem('authToken');
        localStorage.removeItem('userData');
        localStorage.removeItem('cartId'); // Limpiar cartId obsoleto
        window.location.href = '/login';
      }
    }

    function updateAuthNavigation() {
      const authNav = document.getElementById('auth-nav');
      const adminNav = document.getElementById('admin-nav');
      const authToken = localStorage.getItem('authToken');
      const userData = localStorage.getItem('userData');
      
      if (authToken && userData) {
        try {
          const user = JSON.parse(userData);
          const isAdmin = user.role === 'admin';
          
          if (adminNav) {
            adminNav.style.display = isAdmin ? 'inline' : 'none';
          }
          
          authNav.innerHTML = `
            <a href="/profile">ğŸ‘¤ Perfil</a>
            ${isAdmin ? '<a href="/admin/dashboard">âš™ï¸ Admin</a>' : ''}
            <a href="#" data-action="logout">ğŸšª Salir</a>
          `;
        } catch (error) {
          console.error('[v0] Error parsing user data:', error);
          if (adminNav) adminNav.style.display = 'none';
          authNav.innerHTML = `
            <a href="/login">ğŸ”‘ Iniciar SesiÃ³n</a>
            <a href="/register">ğŸ“ Registrarse</a>
          `;
        }
      } else {
        // Usuario no autenticado
        if (adminNav) adminNav.style.display = 'none';
        authNav.innerHTML = `
          <a href="/login">ğŸ”‘ Iniciar SesiÃ³n</a>
          <a href="/register">ğŸ“ Registrarse</a>
        `;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      updateAuthNavigation();
    });
    
    document.addEventListener('click', function(e) {
      if (e.target.matches('[data-action="logout"]')) {
        e.preventDefault();
        logout();
      }
      if (e.target.matches('[data-action="go-to-cart"]')) {
        e.preventDefault();
        goToCart();
      }
    });
  </script>
</body>
</html>
